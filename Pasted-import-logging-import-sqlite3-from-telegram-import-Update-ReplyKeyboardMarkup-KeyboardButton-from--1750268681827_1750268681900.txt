import logging
import sqlite3
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ConversationHandler, ContextTypes

# ğŸ” Ø£Ø¯Ø®Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ø¨ÙˆØªÙƒ Ù‡Ù†Ø§
TOKEN = "Ø¶Ø¹_Ø§Ù„ØªÙˆÙƒÙ†_Ø§Ù„Ø®Ø§Øµ_Ø¨Ùƒ_Ù‡Ù†Ø§"

# ğŸ“¦ Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
conn = sqlite3.connect("ribeh.db")
c = conn.cursor()
c.execute('''CREATE TABLE IF NOT EXISTS users (
    user_id INTEGER PRIMARY KEY,
    username TEXT,
    referrer INTEGER,
    investment INTEGER DEFAULT 0
)''')
c.execute('''CREATE TABLE IF NOT EXISTS payments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    method TEXT,
    proof BLOB
)''')
conn.commit()

# ğŸ› ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø¬Ù„
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ğŸ”˜ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
main_menu = [
    ["ğŸ“¦ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª", "ğŸ’¼ Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ"],
    ["ğŸ’³ Ø¥ÙŠØ¯Ø§Ø¹", "ğŸ’¸ Ø³Ø­Ø¨ Ø§Ù„Ø£Ù…ÙˆØ§Ù„"],
    ["ğŸ§¾ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹", "ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"]
]

# ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    reply_markup = ReplyKeyboardMarkup(main_menu, resize_keyboard=True)
    await update.message.reply_text(
        f"Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ {user.first_name} ÙÙŠ Ø¨ÙˆØª Ribeh Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ ğŸ’¼\nØ§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:", 
        reply_markup=reply_markup
    )
    # Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    with sqlite3.connect("ribeh.db") as conn:
        c = conn.cursor()
        c.execute("INSERT OR IGNORE INTO users (user_id, username) VALUES (?, ?)", (user.id, user.username))
        conn.commit()

# ğŸ“¦ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª
async def show_packages(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸ’¼ Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø©:\n1. 2000 Ø¯Ø¬\n2. 10000 Ø¯Ø¬\n3. 60000 Ø¯Ø¬")

# ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
async def show_profile(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    with sqlite3.connect("ribeh.db") as conn:
        c = conn.cursor()
        c.execute("SELECT investment FROM users WHERE user_id = ?", (user_id,))
        result = c.fetchone()
        invested = result[0] if result else 0
        await update.message.reply_text(f"ğŸ“Š Ù…Ù„ÙÙƒ:\nØ§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±: {invested} Ø¯Ø¬")

# ğŸ’³ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹
async def deposit(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ğŸ’³ Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹:\n1. ğŸ“± Ø¨Ø±ÙŠØ¯ÙŠ Ù…ÙˆØ¨\n2. ğŸ’³ CCP\n3. ğŸŒ Wise\n4. ğŸ’° USDT"
    )

# ğŸ’¸ Ø§Ù„Ø³Ø­Ø¨
async def withdrawal(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸ’¸ Ù„Ø³Ø­Ø¨ Ø§Ù„Ø£Ù…ÙˆØ§Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… ÙˆØ¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨.")

# ğŸ§¾ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹
async def proof(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸ“· Ø£Ø±Ø³Ù„ Ø§Ù„Ø¢Ù† ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹.")
    return 1

# Ø­ÙØ¸ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹
async def save_proof(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if update.message.photo:
        photo_file = await update.message.photo[-1].get_file()
        photo_bytes = await photo_file.download_as_bytearray()
        with sqlite3.connect("ribeh.db") as conn:
            c = conn.cursor()
            c.execute("INSERT INTO payments (user_id, method, proof) VALUES (?, ?, ?)", (user_id, "manual", photo_bytes))
            conn.commit()
        await update.message.reply_text("âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹. Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ù‚Ø±ÙŠØ¨Ù‹Ø§.")
    else:
        await update.message.reply_text("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© ÙÙ‚Ø·.")
    return ConversationHandler.END

# Ø§Ù„Ø¥Ù„ØºØ§Ø¡
async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡. ğŸ›‘")
    return ConversationHandler.END

# ğŸ§  ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
def main():
    app = Application.builder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Regex("^(ğŸ“¦ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª)$"), show_packages))
    app.add_handler(MessageHandler(filters.Regex("^(ğŸ’¼ Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ)$"), show_profile))
    app.add_handler(MessageHandler(filters.Regex("^(ğŸ’³ Ø¥ÙŠØ¯Ø§Ø¹)$"), deposit))
    app.add_handler(MessageHandler(filters.Regex("^(ğŸ’¸ Ø³Ø­Ø¨ Ø§Ù„Ø£Ù…ÙˆØ§Ù„)$"), withdrawal))

    conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^(ğŸ§¾ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹)$"), proof)],
        states={1: [MessageHandler(filters.PHOTO, save_proof)]},
        fallbacks=[CommandHandler("cancel", cancel)],
    )
    app.add_handler(conv_handler)

    app.run_polling()

if __name__ == "__main__":
    main()
